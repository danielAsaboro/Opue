generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Represents a pNode in the Xandeum network
model PNode {
  id                String          @id @default(cuid())
  /// On-chain public key (nodePubkey)
  pubkey            String          @unique
  /// IP:Port for gossip
  gossipEndpoint    String
  /// RPC endpoint URL
  rpcEndpoint       String?
  /// Software version
  version           String
  /// Geographic region
  location          String?
  country           String?
  city              String?
  latitude          Float?
  longitude         Float?
  datacenter        String?
  asn               String?
  firstSeen         DateTime        @default(now())
  lastSeen          DateTime        @updatedAt
  /// Feature set ID
  featureSet        BigInt?
  /// Shred version
  shredVersion      Int?
  /// TPU endpoint
  tpuEndpoint       String?
  performanceAlerts Alert[]
  events            NetworkEvent[]
  snapshots         PNodeSnapshot[]

  @@index([pubkey])
  @@index([lastSeen])
  @@index([location])
}

/// Validator information from getVoteAccounts
model Validator {
  id           String              @id @default(cuid())
  /// Node identity pubkey (may or may not have matching PNode)
  nodePubkey   String              @unique
  /// Vote account pubkey
  votePubkey   String              @unique
  /// In current vote accounts
  isActive     Boolean             @default(true)
  /// In delinquent list
  isDelinquent Boolean             @default(false)
  /// Commission percentage (0-100)
  commission   Int
  firstSeen    DateTime            @default(now())
  lastSeen     DateTime            @updatedAt
  snapshots    ValidatorSnapshot[]

  @@index([nodePubkey])
  @@index([votePubkey])
  @@index([isActive])
}

/// Historical snapshot of validator state
model ValidatorSnapshot {
  id               String    @id @default(cuid())
  timestamp        DateTime  @default(now())
  /// Lamports staked
  activatedStake   BigInt
  /// Last vote slot
  lastVote         BigInt
  /// Root slot
  rootSlot         BigInt
  /// Credits earned this epoch
  epochCredits     BigInt
  /// Credits from prior epoch
  priorCredits     BigInt
  isDelinquent     Boolean
  epochVoteAccount Boolean
  validatorId      String
  validator        Validator @relation(fields: [validatorId], references: [id], onDelete: Cascade)

  @@index([validatorId, timestamp])
  @@index([timestamp])
}

/// Epoch information snapshot
model EpochSnapshot {
  id               String   @id @default(cuid())
  timestamp        DateTime @default(now())
  /// Epoch number
  epoch            Int      @unique
  /// Absolute slot number
  absoluteSlot     BigInt
  /// Block height
  blockHeight      BigInt
  /// Current slot within epoch
  slotIndex        BigInt
  /// Total slots in epoch
  slotsInEpoch     BigInt
  /// Total transactions processed
  transactionCount BigInt
  /// Percentage through epoch (0-100)
  epochProgress    Float

  @@index([epoch])
  @@index([timestamp])
}

/// Performance samples from getRecentPerformanceSamples
model PerformanceSample {
  id                     String   @id @default(cuid())
  timestamp              DateTime @default(now())
  /// Slot when sample was taken
  slot                   BigInt
  /// Number of slots in sample
  numSlots               Int
  /// Total transactions in sample
  numTransactions        Int
  /// Non-vote transactions
  numNonVoteTransactions Int
  /// Sample period in seconds
  samplePeriodSecs       Int
  /// Transactions per second
  tps                    Float
  /// Non-vote TPS
  nonVoteTps             Float
  /// Average time per slot (ms)
  slotTime               Float

  @@index([timestamp])
  @@index([slot])
}

/// Network economics snapshot
model EconomicsSnapshot {
  id                     String   @id @default(cuid())
  timestamp              DateTime @default(now())
  /// Total supply in lamports
  totalSupply            BigInt
  /// Circulating supply
  circulatingSupply      BigInt
  /// Non-circulating supply
  nonCirculatingSupply   BigInt
  /// Epoch for inflation rate
  inflationEpoch         Int
  /// Total inflation rate
  inflationTotal         Float
  /// Validator inflation rate
  inflationValidator     Float
  /// Foundation inflation rate
  inflationFoundation    Float
  /// Total staked lamports
  totalStaked            BigInt
  /// % of supply staked
  stakingParticipation   Float
  stakeMinimumDelegation BigInt

  @@index([timestamp])
}

/// Historical snapshot of pNode state - captured at regular intervals
model PNodeSnapshot {
  id               String   @id @default(cuid())
  timestamp        DateTime @default(now())
  /// online, offline, delinquent
  status           String
  performanceScore Int
  /// Percentage 0-100
  uptime           Float
  /// Milliseconds
  averageLatency   Float
  /// Percentage 0-100
  successRate      Float
  capacityBytes    BigInt
  usedBytes        BigInt
  /// Percentage 0-100
  utilization      Float
  fileSystems      Int
  pnodeId          String
  pnode            PNode    @relation(fields: [pnodeId], references: [id], onDelete: Cascade)

  /// Raw uptime in seconds from pnRPC
  uptimeSeconds    BigInt?
  /// CPU usage percentage from get-stats
  cpuPercent       Float?
  /// RAM usage in bytes from get-stats
  ramUsed          BigInt?
  /// Total RAM in bytes from get-stats
  ramTotal         BigInt?
  /// Active network connections from get-stats
  activeStreams    Int?
  /// Network packets received from get-stats
  packetsReceived  BigInt?
  /// Network packets sent from get-stats
  packetsSent      BigInt?
  /// Whether pNode is publicly accessible
  isPublic         Boolean  @default(false)
  /// pnRPC port (usually 6000)
  pnrpcPort        Int?

  @@index([pnodeId, timestamp])
  @@index([timestamp])
}

/// Network-wide statistics snapshot
model NetworkSnapshot {
  id                   String   @id @default(cuid())
  timestamp            DateTime @default(now())
  totalPNodes          Int
  onlinePNodes         Int
  offlinePNodes        Int
  delinquentPNodes     Int
  totalCapacityBytes   BigInt
  totalUsedBytes       BigInt
  networkUtilization   Float
  healthScore          Int
  averagePerformance   Int
  averageLatency       Float
  versionDistribution  Json?
  geoDistribution      Json?
  activeValidators     Int?
  /// Average validator commission
  averageCommission    Float?
  blockHeight          BigInt?
  currentEpoch         Int?
  currentSlot          BigInt?
  /// Current TPS
  currentTps           Float?
  delinquentValidators Int?
  /// Non-vote TPS
  nonVoteTps           Float?
  /// Total activated stake
  totalStake           BigInt?
  totalValidators      Int?
  /// Total network transactions
  transactionCount     BigInt?

  @@index([timestamp])
}

/// Network events - status changes, alerts, etc.
model NetworkEvent {
  id          String    @id @default(cuid())
  timestamp   DateTime  @default(now())
  type        EventType
  severity    Severity
  title       String
  description String?
  metadata    Json?
  pnodeId     String?
  pnode       PNode?    @relation(fields: [pnodeId], references: [id])

  @@index([timestamp])
  @@index([type])
  @@index([severity])
}

/// User-configurable alerts
model AlertRule {
  id              String     @id @default(cuid())
  name            String
  description     String?
  enabled         Boolean    @default(true)
  /// e.g., "uptime", "latency", "storage"
  metric          String
  /// e.g., "<", ">", "=="
  operator        String
  threshold       Float
  scope           AlertScope @default(NETWORK)
  /// Optional pNode pubkey filter
  pnodeFilter     String?
  notifyEmail     String?
  notifyWebhook   String?
  cooldownMinutes Int        @default(15)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  lastTriggered   DateTime?
  alerts          Alert[]
}

/// Triggered alert instances
model Alert {
  id         String    @id @default(cuid())
  timestamp  DateTime  @default(now())
  severity   Severity
  message    String
  /// The metric value that triggered the alert
  value      Float
  /// The threshold that was crossed
  threshold  Float
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  ruleId     String
  pnodeId    String?
  pnode      PNode?    @relation(fields: [pnodeId], references: [id])
  rule       AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([timestamp])
  @@index([resolved])
}

/// Pre-computed analytics for faster dashboard loading
model DailyAnalytics {
  id             String   @id @default(cuid())
  date           DateTime @unique @db.Date
  avgPNodes      Int
  peakPNodes     Int
  minPNodes      Int
  avgHealthScore Float
  avgPerformance Float
  avgUptime      Float
  avgCapacity    BigInt
  avgUsed        BigInt
  avgUtilization Float
  totalEvents    Int
  criticalEvents Int
  warningEvents  Int
  newPNodes      Int
  lostPNodes     Int

  @@index([date])
}

/// Anomaly detection records
model Anomaly {
  id            String    @id @default(cuid())
  timestamp     DateTime  @default(now())
  /// The metric that showed anomaly
  metric        String
  expectedValue Float
  actualValue   Float
  /// Standard deviations from mean
  deviation     Float
  pnodeId       String?
  description   String?
  confirmed     Boolean?
  reviewedAt    DateTime?

  @@index([timestamp])
  @@index([metric])
}

/// API keys for external access
model ApiKey {
  id            String    @id @default(cuid())
  key           String    @unique
  name          String
  description   String?
  permissions   Json      @default("[]")
  /// Requests per hour
  rateLimit     Int       @default(1000)
  lastUsed      DateTime?
  totalRequests BigInt    @default(0)
  active        Boolean   @default(true)
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([key])
}

enum EventType {
  NODE_ONLINE
  NODE_OFFLINE
  NODE_DELINQUENT
  PERFORMANCE_DEGRADATION
  PERFORMANCE_IMPROVEMENT
  STORAGE_THRESHOLD
  VERSION_UPDATE
  NETWORK_MILESTONE
  ANOMALY_DETECTED
}

enum Severity {
  INFO
  WARNING
  CRITICAL
  SUCCESS
}

enum AlertScope {
  NETWORK
  PNODE
}
